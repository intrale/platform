name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # ── Detectar qué módulos cambiaron ──────────────────────────────
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      app: ${{ steps.filter.outputs.app }}
      users: ${{ steps.filter.outputs.users }}
      tools: ${{ steps.filter.outputs.tools }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            app:
              - 'app/**'
            users:
              - 'users/**'
            tools:
              - 'tools/**'
            shared:
              - 'build.gradle.kts'
              - 'settings.gradle.kts'
              - 'gradle/**'
              - 'buildSrc/**'
              - 'gradle.properties'

  # ── Verificación global de strings ──────────────────────────────
  verify-strings:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.app == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Run verifyNoLegacyStrings
        run: ./gradlew verifyNoLegacyStrings

  # ── Backend ─────────────────────────────────────────────────────
  check-backend:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Check backend
        run: ./gradlew :backend:check :backend:koverVerify :backend:koverHtmlReport

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: |
            backend/build/reports/tests/
            backend/build/test-results/
          retention-days: 14

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-reports
          path: backend/build/reports/kover/
          retention-days: 14

  # ── Users (depende de backend) ──────────────────────────────────
  check-users:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.users == 'true' ||
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Check users
        run: ./gradlew :users:check :users:koverVerify :users:koverHtmlReport

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: users-test-reports
          path: |
            users/build/reports/tests/
            users/build/test-results/
          retention-days: 14

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: users-coverage-reports
          path: users/build/reports/kover/
          retention-days: 14

  # ── App Compose Multiplatform ───────────────────────────────────
  check-app:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.app == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Check app
        run: ./gradlew :app:composeApp:check :app:composeApp:koverVerify :app:composeApp:koverHtmlReport -x compileTestKotlinIosX64

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-test-reports
          path: |
            app/composeApp/build/reports/tests/
            app/composeApp/build/test-results/
          retention-days: 14

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-coverage-reports
          path: app/composeApp/build/reports/kover/
          retention-days: 14

  # ── Tools (KSP processor) ──────────────────────────────────────
  check-tools:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.tools == 'true' ||
      needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Check tools
        run: ./gradlew :tools:forbidden-strings-processor:check

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tools-test-reports
          path: |
            tools/forbidden-strings-processor/build/reports/tests/
            tools/forbidden-strings-processor/build/test-results/
          retention-days: 14

  # ── Gate final — todos los checks deben pasar ───────────────────
  pr-status:
    runs-on: ubuntu-latest
    needs: [detect-changes, verify-strings, check-backend, check-users, check-app, check-tools]
    if: always()
    steps:
      - name: Verify all checks passed
        run: |
          echo "== PR Check Results =="
          echo "verify-strings: ${{ needs.verify-strings.result }}"
          echo "check-backend:  ${{ needs.check-backend.result }}"
          echo "check-users:    ${{ needs.check-users.result }}"
          echo "check-app:      ${{ needs.check-app.result }}"
          echo "check-tools:    ${{ needs.check-tools.result }}"

          # Un job skipped es OK (no hubo cambios en ese módulo)
          # Un job con failure o cancelled es un error
          for result in \
            "${{ needs.verify-strings.result }}" \
            "${{ needs.check-backend.result }}" \
            "${{ needs.check-users.result }}" \
            "${{ needs.check-app.result }}" \
            "${{ needs.check-tools.result }}"; do
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              echo "FAILED: al menos un check falló o fue cancelado"
              exit 1
            fi
          done
          echo "OK: todos los checks pasaron o fueron skipped correctamente"
